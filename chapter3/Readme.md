### What is problem?

이미지는 읽기 전용이라서 한번 빌드되면 절대 바뀌지 않는다. 그래서 이미지에 변경이 필요한 경우에는 컨테이너를 종료하고 이미지를 다시 빌드한다. 하지만 앱 내에서 사용되는 데이터는 분명히 있을 것이다. 예를들면 유저가 폼에 입력한 정보라던지.. 그러한 것들은 이미지가 아닌 컨테이너에 저장된다. 그래서 컨테이너를 삭제하고 다시 시작하면 컨테이너에 저장되어 있던 파일이나 데이터들은 당연하게도 사라진다.

하지만 사라지면 안되는 데이터들도 있다. 예를들면 사용자 활동에 의해 생긴 로그 파일같은 것들...? 아무튼 중요한 것은 그런 경우는 존재할 것이라는 거다. 게다가 우리는 컨테이너를 꽤 자주 제거한다. 제거한다기보다는... 우리의 컨테이너가 금방 쓸모없어진다고 말하는 편이 나을 것 같다. 왜냐하면 우리는 코드를 수정하고 그 코드를 반영하려면 이미지를 새로 빌드하는 수 밖에 없기 때문이다. 어떻게 해결할까?

<br>

### Docker Volumes (Managed by Docker)

도커에는 볼륨이라는 내장 기능이 있다. 볼륨은 데이터를 유지하도록 돕고, 위의 문제를 해결할 수 있다. 볼륨이 뭘까? 사실 볼륨이라는 것은 로컬에 있는 폴더이다. 이미지나 컨테이너에 있는 것이 아니다. 대신 컨테이너로 맵핑이 된다. 다시 말하면 볼륨은 도커가 인식하는 여러분의 컴퓨터에 있는 폴더이고 컨테이너 내부 폴더에 맵핑시키는 방법으로 위의 문제를 해결한다.

`COPY` 명령어랑 다를 것이 무어냐? 라고 물을 수 있는데, `COPY`는 그저 그 당시의 스냅샷을 찍어 이미지에 복사하는 것 뿐이다. 볼륨은 이와 다르다. 컨테이너 내부의 폴더와 호스트 머신의 폴더를 연결할 수 있는 것이다. Volume에 파일을 추가하면 컨테이너 내부에서 액세스할 수 있고 컨테이너가 맵핑된 경로에 파일을 추가하면 호스트 머신에서도 사용할 수 있는 것이다. 그리고 컨테이너를 제거해도 볼륨과 컨테이너는 연결되어 있을 뿐 다른 것이기 때문에 사라지지 않는다.

#### 익명 볼륨

도커가 관리하지만 익명이기 때문에 컨테이너가 존재하는 동안에만 존재합니다. 그리고 이건 위 문제를 해결해주지 못하죠. 컨테이너가 삭제되면 사라집니다.

- 용도: 바인드 마운트와 연계할 때 유용하다. 바인드 마운트로 설정된 외부 경로보다 컨테이너 내부 경로의 우선 순위를 높이는 데 사용될 수 있다.

#### 네임드 볼륨

네임드 볼륨은 익명 볼륨과 다르게 컨테이너가 사라져도 존재합니다. 하지만 편집하거나 직접 볼 필요가 없는 데이터에 적합합니다. 호스트 머신에서 직접 액세스하지는 않을 것이기 때문이죠. 도커가 관리하는 어딘가에 숨겨져있고 어디있는지 찾기 어렵습니다. 우리가 이걸 편집할 이유가 없습니다.

- 용도: 편집하거나 직접 볼 필요가 없는 중요한 데이터를 컨테이너 외부에 저장하고 싶을 때 사용될 수 있다.

<br>

### Bind Mounts (Managed by you)

앞서 말했던 것처럼 코드에 변경사항이 있으면 이미지는 변경되지 않는다. 따라서 이미지를 다시 빌드해야 하는 상황이 오는데, 우리는 개발 중에 이렇게 다시 빌드해야 하는 상황이 꽤 자주 생길 것이다. 이건 상당히 번거로운 것인데 이 문제를 바인드 마운트가 해결해줄 수 있다. 바인드 마운트는 볼륨이랑 비슷하지만 한가지 중요한 차이점이 있다. 볼륨은 도커에 의해 관리되어 해당 파일이 로컬 내 정확한 위치를 모르는 반면에, 바인드 마운트는 파일들이 우리들에 의해 관리된다. 이것이 가능하기 위해서는 우리가 호스트 머신 상에 맵핑될 컨테이너의 경로를 설정해야 한다. 물론 바인드 마운트로 로컬 파일들을 컨테이너에서 사용할 수 있게 되었다고 해서 Dockerfile 의 COPY를 대체할 수 있다는 것은 아니다. docker run 은 개발 중에 사용하는 명령어이다. 개발을 마친 뒤에는 실제로 이 컨테이너를 가져와 서버에 넣어야 하는데 그때도 바인드 바운트로 실행되기를 원하지는 않을 겁니다.

프로덕션 환경, 실제로 제품을 사용하는 환경은 불변의 환경을 원합니다. 코드의 스냅샷을 가지길 원하죠. 그러니까 바인드 마운트가 실제로는 아무 문제가 없어 보여도 COPY 명령어를 대체할 수는 없는 것입니다.

- 용도 : 일반적으로 컨테이너에 라이브 데이터(우리가 작성한 코드 등)를 제공할 때 사용된다.

<br>

### Usage

```
$ docker run -v /app/data ...           ==> 익명 볼륨
$ docker run -v data:/app/data ...      ==> 네임드 볼륨
$ docker run -v /app/data ...           ==> 바인드 마운트
```

모두 `-v` 플래그로 사용될 수 있다.

<br>

### Comparison

1. 익명 볼륨 :

   - 도커에 의해 관리
   - Dockerfile 에서 `VOLUME` 으로 생성 가능
   - 컨테이너에 연결된 볼륨
   - `--rm` 으로 컨테이너를 실행했을 때 컨테이너를 중단하면 같이 삭제됨
   - 컨테이너 간에 데이터를 공유할 수 없음
   - 컨테이너를 삭제 및 재생성 과정 중에 저장해야 하는 데이터가 있다면 익명볼륨은 적합하지 않음
   - 컨테이너에 이미 존재하는 특정 데이터를 잠그는데 유용함
   - 그래서 바운드 마운트에 의해 덮어쓰여지는 것을 방지하는 것에 유용함

2. 네임드 볼륨 :

   - 도커에 의해 관리
   - 특정 컨테이너에만 종속적이지 않음 (어떤 컨테이너와도 연결될 수 있음)
   - 컨테이너 간에 데이터를 공유할 수 있음

3. 바인드 마운트 :
   - 특정 컨테이너에만 종속적이지 않음
   - 컨테이너 간에 데이터를 공유할 수 있음
   - 호스트의 파일 시스템과 연결할 때 주로 쓰이는 것 같음
   - 사실상 컨테이너가 호스트 파일 시스템을 이용한다고 보는 것이 맞는 것 같음
